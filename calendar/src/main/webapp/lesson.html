<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Setup Meeting</title>
<link rel="stylesheet" type="text/css" href="styles/all.css" />
<link href="styles/jquery-ui.css" rel="stylesheet">
<script type="text/javascript" src="scripts/jquery-2.1.4.js"></script>
<script src="scripts/jquery-ui.js"></script>
<script type="text/javascript" src="scripts/ui.js"></script>
<script type="text/javascript" src="scripts/ui/msgbox.js"></script>
<script type="text/javascript" src="scripts/validator.js"></script>
<script type='text/javascript' src='dwr/engine.js'></script>
<script type='text/javascript' src='dwr/interface/CalendarService.js'></script>
<script>
	function switch_div(checkbox) {
		if (checkbox.checked) {
			$('#repeat_option_div').css('display', 'block');
			$('#oneoff_option_div').css('display', 'none');
		} else {
			$('#repeat_option_div').css('display', 'none');
			$('#oneoff_option_div').css('display', 'block');
		}
	};

	function enter_modify_mode() {
		$('#form_title_div').empty();
		$('#form_title_div').append('Modify Lesson');
		$('#delete_btn').css('display', 'initial');
	}

	$(function() {
		// Install validator
		new otms.validator.NonemptyValidator($('#title_input'));
		new otms.validator.NonemptyValidator($('#tutor_input'));
		new otms.validator.TimeValidator($('#timefrom_input'));
		new otms.validator.TimeValidator($('#timeto_input'));
		new otms.validator.DateValidator($('#repeat_datefrom_input'));
		new otms.validator.DateValidator($('#repeat_dateto_input'));
		new otms.validator.DateValidator($('#oneoff_date_input'));

		// Install Bean Manager
		window.beanManager = new otms.validator.BeanManager();
		var bm = window.beanManager;
		bm.reg('title', $('#title_input'));
		bm.reg('tutorName', $('#tutor_input'));
		bm.reg('description', $('#meetingdesc_text'));
		bm.reg('fromTime', $('#timefrom_input'));
		bm.reg('toTime', $('#timeto_input'));
		bm.reg('repeat', $('#repeat_checkbox'));

		bm.reg('repeatFromDate', $('#repeat_datefrom_input'));
		bm.reg('repeatToDate', $('#repeat_dateto_input'));

		bm.reg('weekrepeat.0', $('#repeat_sunday_check'));
		bm.reg('weekrepeat.1', $('#repeat_monday_check'));
		bm.reg('weekrepeat.2', $('#repeat_tuesday_check'));
		bm.reg('weekrepeat.3', $('#repeat_wednesday_check'));
		bm.reg('weekrepeat.4', $('#repeat_thursday_check'));
		bm.reg('weekrepeat.5', $('#repeat_friday_check'));
		bm.reg('weekrepeat.6', $('#repeat_saturday_check'));

		bm.reg('oneoffDate', $('#oneoff_date_input'));

		bm.validate = function(bean, vresult) {
			// First check vresult
			for ( var key in vresult) {
				if (vresult[key] == false) {
					if (key == 'oneoffDate' && bean.repeat) {
						continue;
					}
					if (!bean.repeat
							&& [ 'repeatFromDate', 'repeatToDate' ]
									.includes(key)) {
						continue;
					}
					return false;
				}
			}

			// From time must be smaller than to time
			if (bean.fromTime.total >= bean.toTime.total) {
				this.fail([ 'fromTime', 'toTime' ],
						'From time must be earlier than to time');
				return false;
			}
			if (bean.repeat) {
				// From date must be smaller than to date
				if (bean.repeatFromDate.getTime() >= bean.repeatToDate
						.getTime()) {
					this.fail([ 'repeatFromDate', 'repeatToDate' ],
							'From time must be earlier than to time');
					return false;
				}
				// Check at least one day when repeat

				var res = 0;
				res += bean.repeatSunday;
				res += bean.repeatMonday;
				res += bean.repeatTuesday;
				res += bean.repeatWednesday;
				res += bean.repeatThursday;
				res += bean.repeatFriday;
				res += bean.repeatSaturday;

				if (res == 0) {
					this.fail([ 'weekrepeat.0' ],
							'Choose at least one day to repeat');
					return false;
				}
			}

			return true;
		};

		// Check storage for input parameter
		var eventId = window.sessionStorage.getItem('eventId');
		window.sessionStorage.removeItem('eventId');
		if (eventId != undefined) {
			enter_modify_mode();
			// TODO Load data from server
		}

		$('#confirm_btn').click(
				function(event) {
					var bean = beanManager.getBean();
					// Call Server
					debugger;
					if (bean != null) {
						CalendarService.setupLesson(bean, otms.ui.MessageBox
								.handler($('#form_errormsg_panel')));
					}
				});

		$('#delete_btn').click(function(event) {

		});
	});
</script>
</head>
<body>
	<!--#include virtual="header.html" -->
	<div class="form centerpanel">
		<div id='form_errormsg_panel'></div>
		<div id='form_title_div' class='form_title'>Setup Lesson</div>
		<div class="form_section">Lesson Information</div>
		<input type="text" id='title_input' placeholder="Lesson Title"><input
			type="text" id='tutor_input' placeholder="Your tutor id">
		<textarea id='meetingdesc_text' placeholder="Lesson Description"></textarea>
		<div class="form_section">Lesson Time (your local time)</div>
		<div class='form_row'>
			<div style='display: inline-block; width: 49%'>
				<label class='timelabel2'>From:</label> <input type='text'
					placeholder='8:00' id='timefrom_input' class='timeinput2'
					title='Example: 08:30 11AM 2pm' />
			</div>
			<div style='display: inline-block; width: 49%'>
				<label class='timelabel2'>To:</label> <input type='text'
					placeholder='8:30' id='timeto_input' class='timeinput2'
					title='Example: 08:30 11AM 2pm' />
			</div>
		</div>

		<div class='form_row'>
			<label>Repeated lesson?<input id='repeat_checkbox'
				type="checkbox" checked onclick='switch_div(this)'></label>
		</div>
		<div id='repeat_option_div'>
			<div class='form_row'>
				<div style='display: inline-block; width: 49%'>
					<label class='timelabel2'>Start Date:</label> <input type='text'
						id='repeat_datefrom_input' placeholder='mm/dd/year'
						class='timeinput2' />
				</div>
				<div style='display: inline-block; width: 49%'>
					<label class='timelabel2'>Stop Date:</label> <input type='text'
						id='repeat_dateto_input' placeholder='mm/dd/year'
						class='timeinput2' />
				</div>
			</div>
			<label>Repeat every</label>
			<div>
				<label style='width: 120px;'><input type='checkbox'
					id='repeat_sunday_check'>Sunday</label> <label
					style='width: 120px;'><input type='checkbox'
					id='repeat_monday_check' checked>Monday</label> <label
					style='width: 120px;'><input type='checkbox'
					id='repeat_tuesday_check' checked>Tuesday</label> <label
					style='width: 120px;'><input type='checkbox'
					id='repeat_wednesday_check' checked>Wednesday</label> <label
					style='width: 120px;'><input type='checkbox'
					id='repeat_thursday_check' checked>Thursday</label> <label
					style='width: 120px;'><input type='checkbox'
					id='repeat_friday_check' checked>Friday</label> <label
					style='width: 120px;'><input type='checkbox'
					id='repeat_saturday_check'>Saturday</label>
			</div>
		</div>
		<div id='oneoff_option_div' style='display: none'>
			<label>Meet On:</label> <input type='text' id='oneoff_date_input'
				placeholder='01/01/2015' class='timeinput' />
		</div>
		<div class="form_row">
			<button class="btn_large" id='confirm_btn'>Confirm</button>
			<button class="btn_danger" id='delete_btn'
				style='margin-left: 20px; display: none;'>Delete Lesson</button>
		</div>
	</div>
	<!--#include virtual="footer.html" -->
</body>
</html>